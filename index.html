<html>

<body>

    <div id="output">

    </div>


    <script>

        function noise() {
            for (var x = 0; x < 8; x++) {
                for (var y = 0; y < 8; x++) {
                    const red = ~~(Math.random() * 4);
                    const green = ~~(Math.random() * 4);
                    output.send([144, xy2i(x, y), color(red, green)]);
                }
            }
        }

        function xy2i(x, y) {
            return 16 * (y % 8) + x;
        }
        function color(red, green) {
            return 0b001100 + parseInt(Math.min(Math.max(0, red), 3)) + parseInt(Math.min(Math.max(0, green), 3)) * 8
        }

        var output;

        var midiAccess = null;
        navigator.requestMIDIAccess().then(onMidiAccessSuccess, onMidiAccessFailure);

        function onMidiAccessSuccess(access) {
            midiAccess = access;

            var inputs = midiAccess.inputs;
            var outputs = midiAccess.outputs;

            output = outputs.values().next().value;

            var inputIterators = inputs.values();

            var firstInput = inputIterators.next().value;

            if (!firstInput) return;
            firstInput.onmidimessage = handleMidiMessage;
        }

        function onMidiAccessFailure(error) {
            console.log('Oops. Something were wrong with requestMIDIAccess', error.code);
        }

        function handleMidiMessage(e) {
            // if (e.data[0] !== 0x90) return;
            console.log(e.data);

            // display data
            var data = document.createElement("pre");
            data.innerText = e.data;
            document.querySelector("#output").append(data);
            data.scrollIntoView();

            var buttonId = e.data[1];
            var release = e.data[2] == 0;
            if (!release) {
                return;
            }

            const red = ~~(Math.random() * 4);
            const green = ~~(Math.random() * 4);
            if (buttonId == 104) {
                for (var x = 0; x < 8; x++) {
                    for (var y = 0; y < 8; x++) {
                        output.send([144, xy2i(x, y), color(0, 0)]);
                    }
                }
            } else {
                output.send([144, buttonId, color(red, green)]);
            }
        }

    </script>

</body>

</html>